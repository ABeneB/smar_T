<%- model_class = Tour -%>
<% if current_user %>
  <div class="page-header">
    <h1>Tour</h1>
  </div>
  
  <div class="fieldset">
  <table class="table table-striped">
      <thead>
        <tr>
          <th><%= model_class.human_attribute_name(:place) %></th>
          <th>Art</th>
          <th><%= model_class.human_attribute_name(:location) %></th>
          <th><%= model_class.human_attribute_name(:time) %></th>
          <th><%= model_class.human_attribute_name(:duration) %></th>
          <th>Beschreibung</th>
        </tr>
      </thead>
      <tbody>
        <% @order_tours.each do |order_tour| %>
          <tr>
            <td><%= order_tour.place+1 %></td>
            <td><%= order_tour.kind %></td>
            <td><%= order_tour.location %></td>
            <td><%= order_tour.time %></td>
            <td><%= order_tour.duration %></td>
            <td><%= order_tour.comment %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  
  <% if current_user.is_driver? %>
    <td><%= link_to 'Start', edit_tour_path(@tour), :class => 'btn btn-info' %></td>
    <td><%= link_to 'Pause', edit_tour_path(@tour), :class => 'btn btn-info' %></td>
    <td><%= link_to 'Erledigt', edit_tour_path(@tour), method: :delete, 
          data: { confirm: 'Are you sure?' }, :class => 'btn btn-danger' %></td>   
          
  <input type="text" id="info" disabled>
  <% end %>
  
  <div style='width: 800px;'>
    <div id="map" style='width: 900px; height: 400px;'></div>
  </div>
    <body>
    <div id="map"></div>
    <div id="directions-panel"></div>

    <script>

        function getRandomColor() {
            var colors  = ["red", "darkred", "blue", "darkblue", "green", "darkgreen", "black", "darkgrey"];
            color = _.sample(colors);
            return color;
        }

        function initMap() {
            // creat the map
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: {lat: 51.7491 , lng: 10.29069}
            });

            //set Marker with number of place
            var image = "";
            var summaryPanel = document.getElementById('directions-panel');
            var url_tmp="";
            summaryPanel.innerHTML = '';
            <% @order_tours.each do |order_tour| %>
            summaryPanel.innerHTML +=  "<%=order_tour.latitude%>" + " " + "<%=order_tour.longitude%>" + " ;; ";
            url_tmp = "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+"<%=order_tour.place+1%>"+"|F55850|000000";
            image = url_tmp;
            var beachMarker = new google.maps.Marker({
                position: {lat: parseFloat(<%= order_tour.latitude%>) , lng: parseFloat(<%= order_tour.longitude %>) },
                map: map,
                icon: image
            });
            <% end %>


            // for each road a own color
            // ------- start --------
            /*
                var waypts = [];
                <% @order_tours.each do |order_tour| %>
                waypts.push({
                    location: "<%= order_tour.location %>",
                    stopover: true
                });
                var test = "<%= order_tour.location %>";
                //summaryPanel.innerHTML += test;
                <% end %>

            var cc = new Array[waypts.length];
            var bb = new Array[waypts.length];
            var request = new Array[waypts.length];
                for (var i = 1; i < waypts.length; i++) {
                    summaryPanel.innerHTML += "--- von "+ waypts[i-1].location + " nach "+ waypts[i].location + " ---- ";

                    cc[i] = new google.maps.DirectionsService;
                    bb[i] = new google.maps.DirectionsRenderer({
                        polylineOptions: {
                            strokeColor: getRandomColor(),
                            strokeOpacity: 0.7
                        },
                        suppressMarkers : true,
                    });


                    request[i] = {
                        origin: waypts[i-1].location,
                        destination: waypts[i].location,
                        travelMode: 'DRIVING'
                    };


                    cc[i].route(request[i], function(response, status) {
                        if (status == 'OK') {
                            bb[i].setDirections(response);
                            bb[i].setMap(map);


                        }
                    });


                }  */

/*            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({
                polylineOptions: {
                    strokeColor: "red",
                    strokeOpacity: 0.6
                },
                suppressMarkers : true,
            });
            var directionsService2 = new google.maps.DirectionsService;
            var directionsDisplay2 = new google.maps.DirectionsRenderer({
                polylineOptions: {
                    strokeColor: "blue",
                    strokeOpacity: 0.6
                },
                suppressMarkers : true,
            });

            function calcRoute() {
                var start = "Rosentorstrasse 2, 38640 Goslar";
                var end = "Christiantal 43, 38855 Wernigerode";
                request = {
                    origin: start,
                    destination: end,
                    travelMode: 'DRIVING'
                };


                directionsService.route(request, function(response, status) {
                    if (status == 'OK') {
                        directionsDisplay.setDirections(response);
                        directionsDisplay.setMap(map);


                    }
                });
                var start2 = "In den Lohbalken 1, 38165 Lehre Wendhausen";
                var end2 = "Friedrich-Ebert-Straße 191 37520 Osterode am Harz";
                request = {
                    origin: start2,
                    destination: end2,
                    travelMode: 'DRIVING'
                };


                directionsService2.route(request, function(response, status) {
                    if (status == 'OK') {
                        directionsDisplay2.setDirections(response);
                        directionsDisplay2.setMap(map);


                    }
                });
             }

            calcRoute();*/

          // ------- End -------




        // one color for the road
        // ---- start_2 ------
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({
                polylineOptions: {
                    strokeColor: "blue",
                    strokeOpacity: 0.6
                },
                suppressMarkers : true,
            });
            var waypts = [];
            var summaryPanel = document.getElementById('directions-panel');

            summaryPanel.innerHTML = '';
            <% @order_tours.each do |order_tour| %>
            waypts.push({
                location: "<%= order_tour.location %>",
                stopover: true
            });
            var test = "<%= order_tour.location %>";
            summaryPanel.innerHTML += test;
            <% end %>

            var waypts2 = [];
            for (var i = 1; i < waypts.length-1; i++) {
                waypts2.push({
                    location: waypts[i].location,
                    stopover: waypts[i].stopover,


                })

                var marker = new google.maps.Marker({
                    location: waypts[i].location,
                    map: map,
                    icon: image
                });
                directionsDisplay.setMap(map);
                summaryPanel.innerHTML += waypts[i].location;
            }
            directionsService.route({
                origin: waypts[0].location,
                destination: waypts[waypts.length-1].location,
                waypoints: waypts2,
                optimizeWaypoints: true,
                travelMode: 'DRIVING',

            }, function(response, status) {
                if (status === 'OK') {
                    directionsDisplay.setDirections(response);

                }else {
                    window.alert('Directions request failed due to ' + status);
                }
            });


        }
        // ----- end_2 ------
    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGri49KFy_LkR2nG4q0uZTPsNw_iIWx5A&callback=initMap">
    </script>


  <!--
  <script>

  $(document).ready(function(){
        
        setInterval(function(){findMe(); }, 10000); //alle 10000 Milisekunden wird die Postion ausgelesen
        //könnte anschließend in DB gespeichert werden per ajax. In diesem Prototypen nicht,
        // damit die Test zur Tourenbildung durchgeführt werden können
        
        path = <%=raw @hash.to_json %>
    
        map = new GMaps({
          div: '#map',
          lat: path[0].latitude,
          lng: path[0].longitude
        });
        
        line_path = _.map(path, function(point){
          return [point.latitude, point.longitude]
        })
        
        _.each(path, function(coord){
          map.addMarker({
            lat: coord.latitude,
            lng: coord.longitude,
            title: coord.place
          })
        })
        
        _.each(line_path, function(coord, index){
          if(line_path[index+1]){
            map.drawRoute({
              origin: [coord[0], coord[1]],
              destination: [line_path[index+1][0], line_path[index+1][1]],
              travelMode: 'driving',
              strokeColor: getRandomColor(),
              strokeOpacity: 0.6,
              strokeWeight: 6
            });
          }
        })
      });
      
  function getRandomColor() {
      var colors  = ["red", "darkred", "blue", "darkblue", "green", "darkgreen", "black", "darkgrey"];
      color = _.sample(colors);
      return color;
  }


  </script> -->
<% else %>
ZUGANG VERWEIGERT
<% end %>
