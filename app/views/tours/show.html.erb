<%- model_class = Tour -%>
<% if current_user %>
  <div class="page-header">
    <h1>Tour</h1>
  </div>
  
  <div class="fieldset">
  <table class="table table-striped">
      <thead>
        <tr>
          <th><%= model_class.human_attribute_name(:place) %></th>
          <th>Art</th>
          <th><%= model_class.human_attribute_name(:location) %></th>
          <th><%= model_class.human_attribute_name(:time) %></th>
          <th><%= model_class.human_attribute_name(:duration) %></th>
          <th>Beschreibung</th>
        </tr>
      </thead>
      <tbody>
        <% @order_tours.each do |order_tour| %>
          <tr>
            <td><%= order_tour.place+1 %></td>
            <td><%= order_tour.kind %></td>
            <td><%= order_tour.location %></td>
            <td><%= order_tour.time %></td>
            <td><%= order_tour.duration %></td>
            <td><%= order_tour.comment %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  
  <% if current_user.is_driver? %>
    <td><%= link_to 'Start', edit_tour_path(@tour), :class => 'btn btn-info' %></td>
    <td><%= link_to 'Pause', edit_tour_path(@tour), :class => 'btn btn-info' %></td>
    <td><%= link_to 'Erledigt', edit_tour_path(@tour), method: :delete, 
          data: { confirm: 'Are you sure?' }, :class => 'btn btn-danger' %></td>   
          
  <input type="text" id="info" disabled>
  <% end %>
  
  <div style='width: 800px;'>
    <div id="map" style='width: 900px; height: 400px;'></div>
  </div>
    <body>
    <div id="map"></div>
    <div id="right-panel">


        <br>
        <input type="submit" id="submit">

      <div id="directions-panel"></div>
    </div>
    <script>
        function initMap() {
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({
                    polylineOptions: {
                        strokeColor: "red"
                    },
                suppressMarkers : true,
                icon: image
                });
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 6,
                center: {lat: 41.85, lng: -87.65}
            });
            var image = 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=B|FF0000|000000';
            var beachMarker = new google.maps.Marker({
                position: {lat: -33.890, lng: 151.274},
                map: map,
                icon: image
            });
            directionsDisplay.setMap(map);

            document.getElementById('submit').addEventListener('click', function() {
                calculateAndDisplayRoute(directionsService, directionsDisplay);
            });
        }

        function calculateAndDisplayRoute(directionsService, directionsDisplay) {
            var waypts = [];
            var summaryPanel = document.getElementById('directions-panel');

            summaryPanel.innerHTML = '';
            <% @order_tours.each do |order_tour| %>

            waypts.push({
                location: "<%= order_tour.location %>",
                stopover: true
            });
            var test = "<%= order_tour.location %>";
            //summaryPanel.innerHTML += test;
            <% end %>

            var waypts2 = [];
            for (var i = 1; i < waypts.length-1; i++) {
                waypts2.push({
                    location: waypts[i].location,
                    stopover: waypts[i].stopover,


                })
                var image = 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=B|FF0000|000000';
                var marker = new google.maps.Marker({
                    location: waypts[i].location,
                    map: map,
                    icon: image
                });
                directionsDisplay.setMap(map);
                summaryPanel.innerHTML += waypts[i].location;
            }
            var image = {
                url: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
                // This marker is 20 pixels wide by 32 pixels high.
                size: new google.maps.Size(20, 32),
                // The origin for this image is (0, 0).
                origin: new google.maps.Point(0, 0),
                // The anchor for this image is the base of the flagpole at (0, 32).
                anchor: new google.maps.Point(0, 32)
            };
            directionsService.route({
                origin: waypts[0].location,
                destination: waypts[waypts.length-1].location,
                waypoints: waypts2,
                optimizeWaypoints: true,
                travelMode: 'DRIVING',

            }, function(response, status) {
                if (status === 'OK') {
                    directionsDisplay.polylineOptions.strokeColor = "blue";
                    directionsDisplay.setDirections(response);

                }else {
                    window.alert('Directions request failed due to ' + status);
                }
            });


        }
    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGri49KFy_LkR2nG4q0uZTPsNw_iIWx5A&callback=initMap">
    </script>


  <!--
  <script>

  $(document).ready(function(){
        
        setInterval(function(){findMe(); }, 10000); //alle 10000 Milisekunden wird die Postion ausgelesen
        //könnte anschließend in DB gespeichert werden per ajax. In diesem Prototypen nicht,
        // damit die Test zur Tourenbildung durchgeführt werden können
        
        path = <%=raw @hash.to_json %>
    
        map = new GMaps({
          div: '#map',
          lat: path[0].latitude,
          lng: path[0].longitude
        });
        
        line_path = _.map(path, function(point){
          return [point.latitude, point.longitude]
        })
        
        _.each(path, function(coord){
          map.addMarker({
            lat: coord.latitude,
            lng: coord.longitude,
            title: coord.place
          })
        })
        
        _.each(line_path, function(coord, index){
          if(line_path[index+1]){
            map.drawRoute({
              origin: [coord[0], coord[1]],
              destination: [line_path[index+1][0], line_path[index+1][1]],
              travelMode: 'driving',
              strokeColor: getRandomColor(),
              strokeOpacity: 0.6,
              strokeWeight: 6
            });
          }
        })
      });
      
  function getRandomColor() {
      var colors  = ["red", "darkred", "blue", "darkblue", "green", "darkgreen", "black", "darkgrey"];
      color = _.sample(colors);
      return color;
  }


  </script> -->
<% else %>
ZUGANG VERWEIGERT
<% end %>
